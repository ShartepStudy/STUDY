Семафор – это объект синхронизации, который предоставляет доступ к разделяемому ресурсу ограниченному количеству потоков. 

Семафор содержит:
•	максимальное количество ресурсов, контролируемых семафором;
•	счетчик текущего числа ресурсов. 

Объект ядра «семафор» создается вызовом функции API CreateSemaphore.

  HANDLE CreateSemaphore(
         PSECURITY_ATTRIBUTE psa,// атрибуты безопасности
         LONG lInitialCount, // текущее количество доступных ресурсов
         LONG lMaximumCount, // максимальное количество ресурсов
         PCSTR pszName // имя семафора
);

Синхронизация работы потоков с использованием семафоров состоит в следующем. Предположим, что необходимо предоставить доступ к какому-то ресурсу трем потокам. Сначала объект ядра «семафор» инициализируется и ему передается количество потоков (в нашем случае 3), которые к нему могут обратиться. Далее при каждом обращении к семафору его счетчик ресурсов уменьшается. И когда счетчик уменьшится до 0, то к семафору нельзя будет больше обратиться. При отсоединении потоков от семафора его счетчик ресурсов увеличивается, что позволяет другим потокам обращаться к нему. 

Сигнальному состоянию семафора соответствует значение счетчика ресурсов, большее нуля. Когда счетчик равен
нулю, семафор считается не установленным (сброшенным).

Любой поток может получить дескриптор существующего объекта-семафора, вызвав функцию API OpenSemaphore.

HANDLE OpenSemaphore(
   	DWORD dwDesiredAccess, // права доступа, SEMAPHORE_ALL_ACCESS – полный доступ
        BOOL blnheritHandle, // параметр определяет, будет ли наследоваться
        LPCTSTR pszName // имя семафора
);

Поток может увеличить значение счетчика текущего числа доступных ресурсов на величину lReleaseCount, вызывая функцию API ReleaseSemaphore.

BOOL ReleaseSemaphore( 
	HANDLE hSemaphore, // дескриптор семафора 
	LONG lReleaseCount, // приращение количества доступных ресурсов 
	LPLONG lpPreviousCount // предыдущее значение счетчика ресурсов 
);

.........................................

Для получения доступа к разделяемому ресурсу поток вызывает функцию WaitForSingleObject и передает ей дескриптор семафора,
охраняющего этот ресурс. Функция WaitForSingleObject проверяет у семафора значение счетчика текущего числа ресурсов.
Если оно больше нуля и семафор свободен, то значение счетчика уменьшается на единицу, а  вызывающий поток продолжает выполнение.
При этом важно, что эта операция выполняется для семафора на уровне атомарного доступа. Иначе говоря, пока wait-функция не вернет управление, операционная система не позволит прервать эту операцию  никакому другому потоку. 

Если wait-функция определяет, что счетчик текущего числа ресурсов равен нулю (семафор занят), то система переводит вызывающий поток в состояние ожидания до тех пор, пока другой поток не увеличит значение этого счетчика.